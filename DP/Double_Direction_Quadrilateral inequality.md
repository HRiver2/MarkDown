# 四边形不等式 (Optimization of Quadrilateral Inequality)

最近有一外国小伙发明了一种动态规划的优化方式, 称之为 `四边形不等式优化`, 小编也不知道为什么它叫四边形不等式, 但是事实就是这样, 小编也很疑惑, 本篇记录线性 DP 的优化方式

## 定义

<!-- 
在 $四边形ABCD$ 中, 边 $AB$, $CD$, 对角线 $AC$, $BD$ 有以下不等关系

$$
AD + CD \geq AD + BC
$$
 -->

定义某函数 $f_{i, j}$, 使其满足

$$
f_{a, c} + f_{b, d} \leq f_{a, d} + f_{b, c}
$$

其中, $a \leq b \leq c \leq d$ 则称这个函数满足四边形不等式

用数学归纳法可以由以下式子推得

$$
f_{a, b} + f_{a + 1, b + 1} \geq f_{a, b + 1} + f_{a + 1, b}
$$

推导过程略

## 应用

如果有 DP 方程

$$
f_i = min(f_j + g_{i, j})
$$

只要 $g_{i, j}$ 满足四边形不等式, 则这个问题具有决策单调性

决策单调性即对于阶段 $i$, 假设其最优决策为 $j$ 则一定有阶段 $i + 1$ 的最优决策 $j' \geq j$

## 证明

引入辅助数组 $p_i$ 表示第 $i$ 个阶段的最优决策

则对 $j \in [1, p_i)$ 有

$$
f_{p_i} + g_{p_i, i} \leq f_{j} + g_{j, i}
$$

设 $i' \in (i, n]$, 则 $j \leq p_i \leq i \leq i'$, 由四边形不等式得:

$$
g_{j, i} + g_{p_i, i'} \leq g_{j, i'} + g_{p_i, i}
$$

整理得

$$
g_{p_i, i'} - g_{p_i, i} \leq g_{j, i'} - g_{j, i}
$$

于是有

$$
f_{p_i} + g_{p_i, i'} \leq f_{j} + g_{j, i'}
$$

说明对于阶段 $i'$, 决策 $p_i$ 由于其前面的所有决策, 也就是说一次决策后, 所有候选决策 $j \in [1, p_i)$ 都变成无用决策

## 实现

维护数组 $p_i$, 第 $i$ 阶段选择最优决策 $p_i$ 后修改 $i' \in (i, n]$ 的 $p_{i'}$ 值为 $p_i$

由于决策单调性, 数组 $p$ 单调递增, 一个决策 $j$ 作为最优决策的阶段一定是连续的区间, 所以为了优化时间复杂度, 只按区间记录数组 $p$

对于每个阶段 $i$, 由于前面 $[1, i)$ 的决策作为最优决策的阶段已经被记录在 $p$ 内了, 所以当前 $p_i$ 一定是 $i$ 的最优决策, 直接转移, O(1)

接下来, 尝试寻找 $i$ 作为最优决策的阶段, 已经记录了若干区间的最优决策. 由决策单调性可知, 一定存在一个断点 $k$, 使得它前面的阶段, 最优决策在 $[1, i)$; $k$ 和它后面的阶段, $i$ 不劣于 $[1, i)$ 的任意决策

所以这时区间分为三类

* 第一类, 整个区间在 $k$ 之前, 这种区间无需操作, $O(0)$
* 第二类, 整个区间在 $k$ 之后, 即起点以 $i$ 为决策不会更劣, 这种区间直接删除. 由于共有 $n$ 个决策, 每个决策之多入队一次, 所以均摊 $O(1)$
* 第三类, 区间包含 $k$, 即起点以 $i$ 为决策更劣, 终点以 $i$ 为决策不会更劣. 二分查找 $k$, 将右端点改为 $k - 1$, 在它后面新建一个区间 $[k, n]$, 最优决策暂时赋值为 $i$, $O(logn)$

## 例题[Luogu4767-IOI2000 邮局](https://www.luogu.com.cn/problem/P4767)

有 $n$ 个村庄, 选其中 $m$ 个建邮局, 给出村庄的坐标 $x_i$, 问村庄到最近邮局的距离总和的最小值

$1 \leq m \leq 300, m \leq n \leq 3000, 1 \leq x_i \leq 10000$

### 推导

设计状态 $$